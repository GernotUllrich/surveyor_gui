<%= simple_fields_for 'surveyform', @surveyform || @survey_section.survey do |f| %>
  <%= f.simple_fields_for :survey_sections, @survey_section do |s| %>

    <% if s.object.id -%>
      <%= div_for(s.object) do %>

        <h2 style='position:relative;'>

          <span class="fl ui-icon ui-icon-arrowthick-2-n-s"></span>&nbsp;

          <%= s.object.title %>

          <% if s.object.modifiable %>

            <button type="button" id="edit_section_title"
                    data-replace_survey_section_url="<%=url_for(:action => 'replace_survey_section', :survey_section_id => s.object.id)%>"
                    data-edit_survey_section_url="<%=edit_survey_section_url(s.object.id)%>"
                    data-survey_section_id="<%=s.object.id%>"
            >Edit Section Title</button>

            <button type="button" id="delete_section"
                    data-survey_section_id="<%=s.object.id%>"
                    data-survey_section_url="<%= survey_section_url(s.object.id)%>"
            >Delete Section</button>

          <% end -%>

        </h2>

        <fieldset style="background:white">
          <div class="fields surveysection">
            <%= s.hidden_field :id %>
            <%= s.hidden_field :modifiable %>

            <% if !@survey_locked && (s.object.modifiable?)  -%>

              <% if session[:cut_question] -%>

                <button type="button" id="add_question" class="cut"
                  data-insert_new_question_url="<%=insert_new_question_surveyform_url%>"
                  data-new_question_url="<%=new_question_url%>"
                >Add Question</button>

                <%= button_to_function "Paste Question",
                    '$.get("'+paste_question_surveyform_url(:survey_section_id => s.object.id)+'",
                      {},
                      function(response) {
                        $(".column3").filter(":last").replaceWith(response);
                        refresh_stars();
                        update_uislider();
                      }
                    );
                    ',
                    :style=>'position:relative; left: 35%' %>

              <% else -%>

                <button type="button" id="add_question"
                  data-insert_new_question_url="<%=insert_new_question_surveyform_url%>"
                  data-new_question_url="<%=new_question_url%>"
                >Add Question</button>

              <% end %>
            <% end %>




            <div class="sortable_questions" id="sortable_question<%= s.object.id.to_s %>">
              <%= s.simple_fields_for :questions do |q| %>
                <%= render "question_section", :f => q %>
              <% end %>
            </div>
          <%= button_to_function 'Add Section',
              'cbox = $.colorbox({width:"517px;",
                  height:"167px;",
                  scrolling:false,
                  iframe:true,
                  onClosed:function(){
                      submitted = $("input#pass_cbox_data").val();
                      if (submitted) {
                          $.get("'+
                            url_for(:action => "insert_survey_section",:id => f.object.id)+'",
                            {},
                            function(response) {
                              $("#survey_section_'+s.object.id.to_s+'").after(replace_idx($(".survey_section"),"survey_sections", response));
                            }
                          );
                      }
                   },
                  href:"'+new_survey_section_url+'?prev_section_id='+s.object.id.to_s+'&suppress_header=true&survey_id='+s.object.survey.id.to_s+'", opacity:.3});',
    :style=>'position: relative; left:41.8%; top:25px;' %>
          </div>
        </fieldset>
      <% end %>
    <% else -%>
      <%= s.hidden_field :id %>
      <%= s.hidden_field :title %>
      <%= s.hidden_field :display_order %>
      <%= s.hidden_field :modifiable %>
      <%= s.simple_fields_for :questions do |q| %>
        <%= q.hidden_field :id %>
        <%= q.hidden_field :text %>
        <%= q.hidden_field :display_order %>
        <%= q.hidden_field :pick %>
        <%= q.hidden_field :display_type %>
        <%= q.hidden_field :question_group_id %>
        <%= q.hidden_field :modifiable %>
        <%= q.simple_fields_for :answers do |a| %>
          <%= a.hidden_field :text %>
          <%= a.hidden_field :response_class %>
          <%= a.hidden_field :display_order %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end -%>
